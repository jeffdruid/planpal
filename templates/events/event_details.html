{% extends 'base.html' %}

{% block title %}Event Details{% endblock %}

{% block content %}
<div class="event-details-container">
    <div class="event-details">
        <span class="status-indicator status-{{ event.status|lower }}"></span>
        <h2 style="text-align: center;">Event Details</h2>
        <p><strong>Title:</strong> {{ event.title|title }}</p>
        <p><strong>Date:</strong> {{ event.proposed_date|date:"F j, Y" }}</p>
        <p><strong>Time:</strong> {{ event.proposed_date|time:"H:i" }}</p>
        <p><strong>Description:</strong> {{ event.description|capfirst }}</p>
        <p><strong>Location:</strong> {{ event.location|capfirst }}</p>
        <p><strong>Status:</strong> {{ event.status|capfirst }}</p>
        <p><strong>Created by:</strong> {{ event.created_by.username|capfirst }}</p>

        {% if request.user == event.created_by %}
        <div class="event-actions">
            <a href="{% url 'edit_event' event.id %}" class="edit-btn"><i class="fas fa-edit"></i></a>
            <button class="delete-btn" data-event-id="{{ event.id }}"><i class="fas fa-trash-alt"></i></button>
        </div>
        {% comment %} uncomment the following lines to enable the accept/deny/maybe buttons for testing {% endcomment %}
        {% comment %} {% endif %} {% endcomment %}
        {% else %}
        <br>
        <div class="response-buttons">
            <div class="response-message">
                <p>How would you like to respond to this event?</p>
            </div>
            <form method="post" action="" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="accept">
                <button type="submit" class="btn accept-btn">Accept</button>
            </form>
            <form method="post" action="" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="deny">
                <button type="submit" class="btn deny-btn">Deny</button>
            </form>
            <button class="btn maybe-btn" onclick="openAlternateDateModal()">Maybe</button>
        </div>
        {% comment %} comment the following lines to enable the accept/deny/maybe buttons for testing {% endcomment %}
        {% endif %}
    </div>
    <div class="event-availability">
        <h3>Availability</h3>
        <ul>
            {% for invitation in invitations %}
            {% empty %}
            <li>No invitations sent.</li>
            {% endfor %}
            {% for invitation in event.invitations.all %}
                <li>{{ invitation.user.username|capfirst }}: <span class="status {{ invitation.status|lower }}">{{ invitation.status }}</span> {% if invitation.read %}<span class="read-status">(Read)</span>{% else %}<span class="unread-status">(Unread)</span>{% endif %}</li>
            {% endfor %}
        </ul>
        <h3>Suggested Alternative Dates</h3>
        <ul>
            {% with suggested_dates=invitations|dictsort:"suggested_date" %}
                {% if suggested_dates %}
                    {% for invitation in suggested_dates %}
                        {% if invitation.suggested_date %}
                            <li>{{ invitation.user.username|capfirst }}: {{ invitation.suggested_date|date:"F j, Y" }} - {{ invitation.suggested_date|time:"H:i" }}</li>
                        {% endif %}
                    {% endfor %}
                    {% if not suggested_dates %}
                        <li>No alternate dates suggested.</li>
                    {% endif %}
                {% else %}
                    <li>No alternate dates suggested.</li>
                {% endif %}
            {% endwith %}
        </ul>
    </div>
</div>
<div class="event-invitations">
    {% if request.user == event.created_by %}
        <a href="{% url 'manage_invitations' event.id %}" class="invite-btn">Manage Invitations</a>
    {% endif %}
</div>

<!-- Modal for deleting an event -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Confirm Delete</h2>
        <p>Are you sure you want to delete this event?</p>
        <form method="post" id="deleteForm">
            {% csrf_token %}
            <button type="submit" class="btn-submit">Delete</button>
            <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

<!-- Modal for suggesting alternate dates -->
<div id="alternateDateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Suggest an Alternate Date</h2>
        <form method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="action" value="maybe">
            <div class="form-group">
                <label for="alternate_date">Alternate Date:</label>
                <input type="date" id="alternate_date" name="alternate_date" value="{{ current_date|date:"Y-m-d" }}" required>
                <label for="alternate_time">Time:</label>
                <input type="time" id="alternate_time" name="alternate_time" value="{{ current_time|time:"H:i" }}" required>
            </div>
            <button type="submit" class="btn-submit">Submit</button>
        </form>
    </div>
</div>

<script>
    var deleteModal = document.getElementById("deleteModal");
    var deleteForm = document.getElementById("deleteForm");
    var closeModalBtn = document.getElementsByClassName("close")[0];

    $(".delete-btn").click(function() {
        var eventId = $(this).data("event-id");
        deleteForm.action = "/events/" + eventId + "/delete/";
        deleteModal.style.display = "block";
    });

    closeModalBtn.onclick = function() {
        deleteModal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == deleteModal) {
            deleteModal.style.display = "none";
        }
    }

    function closeModal() {
        deleteModal.style.display = "none";
    }

    function openAlternateDateModal() {
        document.getElementById("alternateDateModal").style.display = "block";
    }
</script>

{% endblock %}
